var gulp        = require("gulp");
var sass        = require("gulp-sass");
var rename      = require('gulp-rename');
var imagemin    = require('gulp-imagemin');
var cache       = require('gulp-cache');
var postcss     = require('gulp-postcss');
var sourcemaps  = require('gulp-sourcemaps');
var scss        = require('postcss-scss');
var postcssFunctions = require('postcss-functions');
var chroma      = require('chroma-js');
const osTmpdir  = require('os-tmpdir');

osTmpdir();
//=> '/var/folders/m3/5574nnhn0yj488ccryqr7tc80000gn/T'


gulp.task('sass', function () {
    return gulp.src(['./**/sass/*.scss'])
        .pipe(sass({
            outputStyle: 'expanded',
            precision: 5,
            require: ('sass-yiq'),
            onError: function (err) {
                notify().write(err);
            }
        }))
        .pipe(rename(function (path) {
            path.dirname += "/../";
        }))
        .pipe(gulp.dest('./'))
});

gulp.task('css', function () {
  return gulp.src('./**/sass/*.scss')
    processors = [
        require('postcss-functions'),
        require('node-sass'),
        require('node-sass-utils'),
        require('chromatic-postcss'),
        {syntax: scss}]
      .pipe( sourcemaps.init() )
      .pipe(postcss(processors))
      .pipe( sourcemaps.write('.') )
      .pipe( gulp.dest('./') );
});

gulp.task('images', function(){
    return gulp.src('./**/assets/*')
        .pipe(cache(imagemin({
        })))
        .pipe(gulp.dest('./**/assets/*'))
});

gulp.task('default', ['sass','css','images']);

///
From latest gulpfile:
sass.render({
            file: './**/sass/*.scss',
            functions: 'chromatic'
        })
